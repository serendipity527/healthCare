# âœ… STOMP WebSocket é…ç½®æ£€æŸ¥æ¸…å•

## ğŸ“‹ åç«¯é…ç½®æ£€æŸ¥

### 1. StompWebSocketConfig.java
æ–‡ä»¶ä½ç½®ï¼š`src/main/java/com/yihu/agent/config/StompWebSocketConfig.java`

âœ… **å¿…é¡»åŒ…å«**ï¼š
```java
registry.addEndpoint("/ws/chat-stomp")
        .setAllowedOriginPatterns("*")  // â† æ³¨æ„æ˜¯ Patterns ä¸æ˜¯ Origins
        .withSockJS();
```

âŒ **é”™è¯¯å†™æ³•**ï¼š
```java
.setAllowedOrigins("*")  // â† ä¸æ”¯æŒé€šé…ç¬¦ï¼Œä¼šå¯¼è‡´ CORS é”™è¯¯
```

### 2. WebMvcConfig.java ï¼ˆé‡è¦ï¼ï¼‰
æ–‡ä»¶ä½ç½®ï¼š`src/main/java/com/yihu/agent/config/WebMvcConfig.java`

âœ… **å¿…é¡»åˆ›å»ºæ­¤æ–‡ä»¶**ï¼š
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .exposedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

### 3. StompChatController.java
æ–‡ä»¶ä½ç½®ï¼š`src/main/java/com/yihu/agent/controller/StompChatController.java`

âœ… **å¿…é¡»åŒ…å«**ï¼š
```java
@MessageMapping("/chat")           // â† å®¢æˆ·ç«¯å‘é€åˆ° /app/chat
@SendTo("/topic/messages")         // â† å¹¿æ’­åˆ° /topic/messages
public SimpleResponse handleChatMessage(@Payload SimpleMessage message) {
    // ...
}
```

## ğŸ“‹ å‰ç«¯é…ç½®æ£€æŸ¥

### 1. index.html - STOMP è¿æ¥åœ°å€
æ–‡ä»¶ä½ç½®ï¼š`src/main/resources/index.html`

âœ… **è¿æ¥åœ°å€**ï¼š
```javascript
const stompWsUrl = "http://localhost:8080/ws/chat-stomp";
```

### 2. index.html - è®¢é˜…é¢‘é“
âœ… **å¿…é¡»è®¢é˜…**ï¼š
```javascript
stompClient.subscribe('/topic/messages', function(messageOutput) {
    // ...
});
```

âŒ **é”™è¯¯å†™æ³•**ï¼š
```javascript
stompClient.subscribe('/topic/public', ...)  // â† é¢‘é“åä¸åŒ¹é…
```

### 3. index.html - å‘é€ç›®çš„åœ°
âœ… **æ­£ç¡®å†™æ³•**ï¼š
```javascript
stompClient.publish({
    destination: '/app/chat',
    body: JSON.stringify({
        sender: username,
        content: message
    })
});
```

âŒ **é”™è¯¯å†™æ³•**ï¼š
```javascript
destination: '/app/chat.sendMessage',  // â† è·¯å¾„ä¸åŒ¹é…
body: JSON.stringify({
    from: username,    // â† å­—æ®µåä¸åŒ¹é…
    text: message      // â† å­—æ®µåä¸åŒ¹é…
})
```

## ğŸ”„ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šç¡®è®¤æ‰€æœ‰æ–‡ä»¶éƒ½å·²ä¿®æ”¹
- [ ] `StompWebSocketConfig.java` - æ·»åŠ  `.setAllowedOriginPatterns("*")`
- [ ] `WebMvcConfig.java` - æ–°å»ºæ–‡ä»¶ï¼Œé…ç½®å…¨å±€ CORS
- [ ] `StompChatController.java` - ç¡®è®¤è·¯å¾„å’Œæ¶ˆæ¯æ ¼å¼
- [ ] `index.html` - ä¿®æ­£è®¢é˜…é¢‘é“ã€å‘é€ç›®çš„åœ°ã€æ¶ˆæ¯æ ¼å¼

### æ­¥éª¤ 2ï¼šé‡å¯åç«¯åº”ç”¨
âš ï¸ **é‡è¦**ï¼šä¿®æ”¹é…ç½®åå¿…é¡»é‡å¯ï¼

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ Maven
mvn spring-boot:run

# æ–¹æ³• 2ï¼šåœ¨ IDEA ä¸­
ç‚¹å‡»åœæ­¢æŒ‰é’®ï¼Œç„¶åé‡æ–°è¿è¡Œ HealthCareApplication
```

### æ­¥éª¤ 3ï¼šè®¿é—®å‰ç«¯é¡µé¢
æ¨èä½¿ç”¨åç«¯æœåŠ¡å™¨è®¿é—®ï¼ˆé¿å… CORS é—®é¢˜ï¼‰ï¼š
```
http://localhost:8080/index.html
```

æˆ–ä½¿ç”¨ IDEA å†…ç½®æœåŠ¡å™¨ï¼ˆéœ€è¦æ­£ç¡®é…ç½® CORSï¼‰ï¼š
```
http://localhost:63342/.../index.html
```

### æ­¥éª¤ 4ï¼šæµ‹è¯•è¿æ¥
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° "STOMP åè®®" æ ‡ç­¾
3. è¾“å…¥ç”¨æˆ·å
4. ç‚¹å‡» "è¿æ¥ (STOMP)"
5. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º

## âœ… æˆåŠŸæ ‡å¿—

### æµè§ˆå™¨æ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š
```javascript
SockJS connection opened
STOMP Debug: connected to server undefined
STOMP Connected: ...
âœ… STOMP è¿æ¥æˆåŠŸï¼
ğŸ‘¤ å½“å‰ç”¨æˆ·: xxx
Join message sent
Received message: {...}
â† æ¥è‡ª xxx çš„æ¶ˆæ¯: åŠ å…¥äº†èŠå¤©å®¤
```

### Network æ ‡ç­¾åº”è¯¥æ˜¾ç¤ºï¼š
```
/ws/chat-stomp/info?t=...
  Status: 200 OK
  Response Headers:
    Access-Control-Allow-Origin: http://localhost:63342
    (æˆ– *)
```

### å‘é€æ¶ˆæ¯ååº”è¯¥çœ‹åˆ°ï¼š
```
Sending message: {sender: "xxx", content: "æµ‹è¯•æ¶ˆæ¯"}
â† æ¥è‡ª xxx çš„æ¶ˆæ¯: æµ‹è¯•æ¶ˆæ¯
```

## âŒ å¤±è´¥æ ‡å¿—

### CORS é”™è¯¯ï¼ˆæœªä¿®å¤ï¼‰
```
Access to XMLHttpRequest at 'http://localhost:8080/ws/chat-stomp/info' 
from origin 'http://localhost:63342' has been blocked by CORS policy
```

**åŸå› **ï¼š
- ç¼ºå°‘ `WebMvcConfig.java` æ–‡ä»¶
- æˆ– `StompWebSocketConfig.java` ä½¿ç”¨äº† `.setAllowedOrigins("*")` è€Œä¸æ˜¯ `Patterns`
- æˆ–æœªé‡å¯åç«¯åº”ç”¨

### è¿æ¥å¤±è´¥
```
âŒ STOMP è¿æ¥å¤±è´¥: ...
```

**å¯èƒ½åŸå› **ï¼š
- åç«¯æœåŠ¡æœªå¯åŠ¨
- ç«¯å£ 8080 è¢«å ç”¨
- é˜²ç«å¢™é˜»æ­¢è¿æ¥
- ç½‘ç»œé—®é¢˜

### è®¢é˜…å¤±è´¥
è¿æ¥æˆåŠŸï¼Œä½†æ”¶ä¸åˆ°æ¶ˆæ¯

**å¯èƒ½åŸå› **ï¼š
- è®¢é˜…é¢‘é“ä¸åŒ¹é…ï¼ˆåº”è¯¥æ˜¯ `/topic/messages`ï¼‰
- åç«¯ `@SendTo` è·¯å¾„é”™è¯¯
- æ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…

## ğŸ” å¿«é€Ÿè¯Šæ–­

### æ£€æŸ¥ 1ï¼šCORS é…ç½®
```bash
# ä½¿ç”¨ curl æµ‹è¯• CORS
curl -H "Origin: http://localhost:63342" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     http://localhost:8080/ws/chat-stomp/info
```

**é¢„æœŸç»“æœ**ï¼š
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:63342
Access-Control-Allow-Methods: GET,POST,...
```

### æ£€æŸ¥ 2ï¼šWebSocket ç«¯ç‚¹
```bash
# æµ‹è¯• info ç«¯ç‚¹
curl http://localhost:8080/ws/chat-stomp/info
```

**é¢„æœŸç»“æœ**ï¼š
```json
{
  "websocket": true,
  "origins": ["*:*"],
  "cookie_needed": false,
  "entropy": ...
}
```

### æ£€æŸ¥ 3ï¼šSpring Boot æ—¥å¿—
å¯åŠ¨åç«¯æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
Mapped "{[/ws/chat-stomp],methods=[GET],produces=[application/json;charset=UTF-8]}"
Mapped "{[/ws/chat-stomp/**]}"
```

## ğŸ“ å¸¸è§é—®é¢˜é€ŸæŸ¥

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| CORS é”™è¯¯ | ç¼ºå°‘ WebMvcConfig | åˆ›å»º WebMvcConfig.java |
| CORS é”™è¯¯ | ä½¿ç”¨äº† setAllowedOrigins | æ”¹ä¸º setAllowedOriginPatterns |
| CORS é”™è¯¯ | æœªé‡å¯åç«¯ | é‡å¯ Spring Boot åº”ç”¨ |
| è¿æ¥å¤±è´¥ | åç«¯æœªå¯åŠ¨ | å¯åŠ¨åç«¯åº”ç”¨ |
| è¿æ¥å¤±è´¥ | ç«¯å£å ç”¨ | æ›´æ¢ç«¯å£æˆ–åœæ­¢å ç”¨è¿›ç¨‹ |
| æ”¶ä¸åˆ°æ¶ˆæ¯ | è®¢é˜…é¢‘é“é”™è¯¯ | ç¡®è®¤è®¢é˜… /topic/messages |
| æ”¶ä¸åˆ°æ¶ˆæ¯ | å‘é€è·¯å¾„é”™è¯¯ | ç¡®è®¤å‘é€åˆ° /app/chat |
| æ”¶ä¸åˆ°æ¶ˆæ¯ | æ¶ˆæ¯æ ¼å¼é”™è¯¯ | ç¡®è®¤ä½¿ç”¨ {sender, content} |

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ
1. âœ… ç›´æ¥è®¿é—® `http://localhost:8080/index.html`ï¼ˆæ¨èï¼‰
2. âœ… ä½¿ç”¨ `.setAllowedOriginPatterns("*")`
3. âœ… å¯ç”¨è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### ç”Ÿäº§ç¯å¢ƒ
1. âš ï¸ ä¸è¦ä½¿ç”¨ `"*"`ï¼Œè®¾ç½®å…·ä½“åŸŸå
2. âš ï¸ ä½¿ç”¨ HTTPS (wss://)
3. âš ï¸ é…ç½® Spring Security
4. âš ï¸ é™åˆ¶å…è®¸çš„æ¥æºã€æ–¹æ³•å’Œå¤´éƒ¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `CORS_é—®é¢˜è§£å†³æ–¹æ¡ˆ.md` - CORS è¯¦ç»†è§£é‡Š
- `STOMP_æµ‹è¯•æŒ‡å—.md` - å®Œæ•´æµ‹è¯•æ­¥éª¤
- `test-stomp.html` - ç‹¬ç«‹æµ‹è¯•å·¥å…·

## ğŸ‰ å…¨éƒ¨æ­£ç¡®çš„æ ‡å¿—

å½“çœ‹åˆ°ä»¥ä¸‹æ‰€æœ‰ç°è±¡æ—¶ï¼Œè¡¨ç¤ºé…ç½®å®Œå…¨æ­£ç¡®ï¼š

- âœ… åç«¯å¯åŠ¨æ— é”™è¯¯
- âœ… è®¿é—® `http://localhost:8080/index.html` é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ç‚¹å‡» "è¿æ¥ (STOMP)" åç«‹å³æ˜¾ç¤º "âœ… STOMP è¿æ¥æˆåŠŸï¼"
- âœ… è‡ªåŠ¨æ”¶åˆ° "åŠ å…¥èŠå¤©å®¤" çš„å¹¿æ’­æ¶ˆæ¯
- âœ… å‘é€æ¶ˆæ¯åç«‹å³æ”¶åˆ°æ ¼å¼åŒ–çš„å›å¤
- âœ… æµè§ˆå™¨æ§åˆ¶å°æ— ä»»ä½•é”™è¯¯
- âœ… Network æ ‡ç­¾ä¸­æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯ 200 çŠ¶æ€
- âœ… å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾å¯ä»¥äº’ç›¸æ”¶å‘æ¶ˆæ¯

æ­å–œï¼Œä½ çš„ STOMP WebSocket é…ç½®å®Œå…¨æ­£ç¡®ï¼ğŸŠ

