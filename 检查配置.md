# ✅ STOMP WebSocket 配置检查清单

## 📋 后端配置检查

### 1. StompWebSocketConfig.java
文件位置：`src/main/java/com/yihu/agent/config/StompWebSocketConfig.java`

✅ **必须包含**：
```java
registry.addEndpoint("/ws/chat-stomp")
        .setAllowedOriginPatterns("*")  // ← 注意是 Patterns 不是 Origins
        .withSockJS();
```

❌ **错误写法**：
```java
.setAllowedOrigins("*")  // ← 不支持通配符，会导致 CORS 错误
```

### 2. WebMvcConfig.java （重要！）
文件位置：`src/main/java/com/yihu/agent/config/WebMvcConfig.java`

✅ **必须创建此文件**：
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .exposedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

### 3. StompChatController.java
文件位置：`src/main/java/com/yihu/agent/controller/StompChatController.java`

✅ **必须包含**：
```java
@MessageMapping("/chat")           // ← 客户端发送到 /app/chat
@SendTo("/topic/messages")         // ← 广播到 /topic/messages
public SimpleResponse handleChatMessage(@Payload SimpleMessage message) {
    // ...
}
```

## 📋 前端配置检查

### 1. index.html - STOMP 连接地址
文件位置：`src/main/resources/index.html`

✅ **连接地址**：
```javascript
const stompWsUrl = "http://localhost:8080/ws/chat-stomp";
```

### 2. index.html - 订阅频道
✅ **必须订阅**：
```javascript
stompClient.subscribe('/topic/messages', function(messageOutput) {
    // ...
});
```

❌ **错误写法**：
```javascript
stompClient.subscribe('/topic/public', ...)  // ← 频道名不匹配
```

### 3. index.html - 发送目的地
✅ **正确写法**：
```javascript
stompClient.publish({
    destination: '/app/chat',
    body: JSON.stringify({
        sender: username,
        content: message
    })
});
```

❌ **错误写法**：
```javascript
destination: '/app/chat.sendMessage',  // ← 路径不匹配
body: JSON.stringify({
    from: username,    // ← 字段名不匹配
    text: message      // ← 字段名不匹配
})
```

## 🔄 部署步骤

### 步骤 1：确认所有文件都已修改
- [ ] `StompWebSocketConfig.java` - 添加 `.setAllowedOriginPatterns("*")`
- [ ] `WebMvcConfig.java` - 新建文件，配置全局 CORS
- [ ] `StompChatController.java` - 确认路径和消息格式
- [ ] `index.html` - 修正订阅频道、发送目的地、消息格式

### 步骤 2：重启后端应用
⚠️ **重要**：修改配置后必须重启！

```bash
# 方法 1：使用 Maven
mvn spring-boot:run

# 方法 2：在 IDEA 中
点击停止按钮，然后重新运行 HealthCareApplication
```

### 步骤 3：访问前端页面
推荐使用后端服务器访问（避免 CORS 问题）：
```
http://localhost:8080/index.html
```

或使用 IDEA 内置服务器（需要正确配置 CORS）：
```
http://localhost:63342/.../index.html
```

### 步骤 4：测试连接
1. 打开浏览器开发者工具（F12）
2. 切换到 "STOMP 协议" 标签
3. 输入用户名
4. 点击 "连接 (STOMP)"
5. 观察控制台输出

## ✅ 成功标志

### 浏览器控制台应该显示：
```javascript
SockJS connection opened
STOMP Debug: connected to server undefined
STOMP Connected: ...
✅ STOMP 连接成功！
👤 当前用户: xxx
Join message sent
Received message: {...}
← 来自 xxx 的消息: 加入了聊天室
```

### Network 标签应该显示：
```
/ws/chat-stomp/info?t=...
  Status: 200 OK
  Response Headers:
    Access-Control-Allow-Origin: http://localhost:63342
    (或 *)
```

### 发送消息后应该看到：
```
Sending message: {sender: "xxx", content: "测试消息"}
← 来自 xxx 的消息: 测试消息
```

## ❌ 失败标志

### CORS 错误（未修复）
```
Access to XMLHttpRequest at 'http://localhost:8080/ws/chat-stomp/info' 
from origin 'http://localhost:63342' has been blocked by CORS policy
```

**原因**：
- 缺少 `WebMvcConfig.java` 文件
- 或 `StompWebSocketConfig.java` 使用了 `.setAllowedOrigins("*")` 而不是 `Patterns`
- 或未重启后端应用

### 连接失败
```
❌ STOMP 连接失败: ...
```

**可能原因**：
- 后端服务未启动
- 端口 8080 被占用
- 防火墙阻止连接
- 网络问题

### 订阅失败
连接成功，但收不到消息

**可能原因**：
- 订阅频道不匹配（应该是 `/topic/messages`）
- 后端 `@SendTo` 路径错误
- 消息格式不匹配

## 🔍 快速诊断

### 检查 1：CORS 配置
```bash
# 使用 curl 测试 CORS
curl -H "Origin: http://localhost:63342" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     http://localhost:8080/ws/chat-stomp/info
```

**预期结果**：
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:63342
Access-Control-Allow-Methods: GET,POST,...
```

### 检查 2：WebSocket 端点
```bash
# 测试 info 端点
curl http://localhost:8080/ws/chat-stomp/info
```

**预期结果**：
```json
{
  "websocket": true,
  "origins": ["*:*"],
  "cookie_needed": false,
  "entropy": ...
}
```

### 检查 3：Spring Boot 日志
启动后端时，应该看到：
```
Mapped "{[/ws/chat-stomp],methods=[GET],produces=[application/json;charset=UTF-8]}"
Mapped "{[/ws/chat-stomp/**]}"
```

## 📞 常见问题速查

| 症状 | 可能原因 | 解决方案 |
|-----|---------|---------|
| CORS 错误 | 缺少 WebMvcConfig | 创建 WebMvcConfig.java |
| CORS 错误 | 使用了 setAllowedOrigins | 改为 setAllowedOriginPatterns |
| CORS 错误 | 未重启后端 | 重启 Spring Boot 应用 |
| 连接失败 | 后端未启动 | 启动后端应用 |
| 连接失败 | 端口占用 | 更换端口或停止占用进程 |
| 收不到消息 | 订阅频道错误 | 确认订阅 /topic/messages |
| 收不到消息 | 发送路径错误 | 确认发送到 /app/chat |
| 收不到消息 | 消息格式错误 | 确认使用 {sender, content} |

## 🎯 最佳实践

### 开发环境
1. ✅ 直接访问 `http://localhost:8080/index.html`（推荐）
2. ✅ 使用 `.setAllowedOriginPatterns("*")`
3. ✅ 启用详细的调试日志

### 生产环境
1. ⚠️ 不要使用 `"*"`，设置具体域名
2. ⚠️ 使用 HTTPS (wss://)
3. ⚠️ 配置 Spring Security
4. ⚠️ 限制允许的来源、方法和头部

## 📚 相关文档

- `CORS_问题解决方案.md` - CORS 详细解释
- `STOMP_测试指南.md` - 完整测试步骤
- `test-stomp.html` - 独立测试工具

## 🎉 全部正确的标志

当看到以下所有现象时，表示配置完全正确：

- ✅ 后端启动无错误
- ✅ 访问 `http://localhost:8080/index.html` 页面正常加载
- ✅ 点击 "连接 (STOMP)" 后立即显示 "✅ STOMP 连接成功！"
- ✅ 自动收到 "加入聊天室" 的广播消息
- ✅ 发送消息后立即收到格式化的回复
- ✅ 浏览器控制台无任何错误
- ✅ Network 标签中所有请求都是 200 状态
- ✅ 多个浏览器标签可以互相收发消息

恭喜，你的 STOMP WebSocket 配置完全正确！🎊

