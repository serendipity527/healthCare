好的！我来给您设计一个基于 **LangChain4j + LangGraph4j + WebSocket** 的 MVP 架构方案。

## 🏗️ 项目架构图

让我先创建一个清晰的架构图：

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (Frontend)                        │
├─────────────────────────────────────────────────────────────────┤
│  Vue 3 / React / 原生 HTML + JS                                 │
│  └─ WebSocket Client (实时对话)                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │ WebSocket 连接
┌────────────────────────────▼────────────────────────────────────┐
│                    WebSocket 网关层                              │
├─────────────────────────────────────────────────────────────────┤
│  WebSocketHandler                                               │
│  ├─ 消息路由                                                     │
│  ├─ 会话管理 (SessionManager)                                   │
│  └─ 消息序列化/反序列化                                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                  核心业务层 (Core Service)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │         LangGraph4j 状态机引擎 (核心)                  │     │
│  ├───────────────────────────────────────────────────────┤     │
│  │                                                       │     │
│  │  ┌──────────┐      ┌──────────┐      ┌──────────┐   │     │
│  │  │ START    │─────▶│ COLLECT  │─────▶│ ANALYZE  │   │     │
│  │  │  状态    │      │ INFO     │      │  信息    │   │     │
│  │  └──────────┘      │  状态    │      │  状态    │   │     │
│  │                    └──────────┘      └────┬─────┘   │     │
│  │                         │                  │         │     │
│  │                         │ 信息不足          │ 信息充足 │     │
│  │                         │                  │         │     │
│  │                    ┌────▼─────┐      ┌────▼─────┐   │     │
│  │                    │ QUESTION │      │ RECOMMEND│   │     │
│  │                    │ 追问状态  │      │  推荐状态 │   │     │
│  │                    └────┬─────┘      └────┬─────┘   │     │
│  │                         │                  │         │     │
│  │                         └─────────┬────────┘         │     │
│  │                                   │                  │     │
│  │                              ┌────▼─────┐            │     │
│  │                              │   END    │            │     │
│  │                              │  结束    │            │     │
│  │                              └──────────┘            │     │
│  └───────────────────────────────────────────────────────┘     │
│                             │                                  │
│  ┌──────────────────────────▼──────────────────────────┐       │
│  │          LangChain4j LLM 服务层                      │       │
│  ├──────────────────────────────────────────────────────┤       │
│  │  • ChatLanguageModel (对话模型)                      │       │
│  │  • ConversationChain (对话链)                        │       │
│  │  • PromptTemplate (提示词模板)                       │       │
│  │  • ChatMemory (对话记忆)                             │       │
│  │  • Tools/Functions (工具调用)                        │       │
│  └──────────────────────────────────────────────────────┘       │
│                             │                                  │
└─────────────────────────────┼──────────────────────────────────┘
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│                      数据访问层 (Data Layer)                      │
├──────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Redis           │  │ Memory Store    │  │ JSON Files      │  │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤  │
│  │ • 会话状态      │  │ • 医生数据      │  │ • 药物知识库    │  │
│  │ • 对话历史      │  │ • 用户信息      │  │ • 疾病映射      │  │
│  │ • 收集的信息    │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼────────────────────────────────────┐
│                      外部服务层 (External)                        │
├──────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                     │
│  │ OpenAI API       │  │ 通义千问 API      │  (选择一个)         │
│  │ GPT-4 / GPT-3.5  │  │ 或其他国产 LLM    │                     │
│  └──────────────────┘  └──────────────────┘                     │
└──────────────────────────────────────────────────────────────────┘
```

## 📋 实现思路

### **1️⃣ LangGraph4j 状态机设计**

```
状态定义：
├─ START: 初始欢迎状态
├─ COLLECT_INFO: 信息收集状态（主循环）
├─ ANALYZE: 分析收集的信息是否足够
├─ QUESTION: 生成追问（信息不足时）
├─ RECOMMEND: 推荐医生或药物（信息充足时）
└─ END: 结束对话

状态转换条件：
• COLLECT_INFO → ANALYZE: 用户回复后
• ANALYZE → QUESTION: 必要信息缺失
• ANALYZE → RECOMMEND: 信息完整度 >= 80%
• QUESTION → COLLECT_INFO: 继续收集
• RECOMMEND → END: 推荐完成
```

### **2️⃣ 必须收集的信息字段**

```java
class PatientInfo {
    String age;           // 年龄 ✓
    String gender;        // 性别 ✓
    String symptoms;      // 主要症状 ✓
    String duration;      // 持续时间 ✓
    String severity;      // 严重程度
    String otherSymptoms; // 伴随症状
    String medicalHistory;// 既往病史
    String allergies;     // 过敏史
}
```

### **3️⃣ LangChain4j 工具函数（Tools）**

```java
@Tool("检查信息完整性")
boolean checkInfoCompleteness(PatientInfo info);

@Tool("推荐科室")
String recommendDepartment(PatientInfo info);

@Tool("推荐医生")
List<Doctor> recommendDoctors(String department);

@Tool("推荐非处方药")
List<Medicine> recommendOTCMedicine(PatientInfo info);
```

## 📂 项目结构

```
healthCare/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/com/yihu/agent/
│   │   │   ├── HealthCareApplication.java
│   │   │   │
│   │   │   ├── config/                    # 配置层
│   │   │   │   ├── WebSocketConfig.java
│   │   │   │   ├── LangChainConfig.java
│   │   │   │   └── RedisConfig.java (可选)
│   │   │   │
│   │   │   ├── websocket/                 # WebSocket 层
│   │   │   │   ├── ChatWebSocketHandler.java
│   │   │   │   └── SessionManager.java
│   │   │   │
│   │   │   ├── graph/                     # LangGraph 状态机
│   │   │   │   ├── MedicalAgentGraph.java         (核心)
│   │   │   │   ├── states/
│   │   │   │   │   ├── AgentState.java            (状态定义)
│   │   │   │   │   └── StateTransition.java       (转换逻辑)
│   │   │   │   └── nodes/
│   │   │   │       ├── CollectInfoNode.java
│   │   │   │       ├── AnalyzeNode.java
│   │   │   │       ├── QuestionNode.java
│   │   │   │       └── RecommendNode.java
│   │   │   │
│   │   │   ├── service/                   # 业务服务层
│   │   │   │   ├── ChatService.java
│   │   │   │   ├── LLMService.java
│   │   │   │   ├── RecommendationService.java
│   │   │   │   └── InfoExtractionService.java
│   │   │   │
│   │   │   ├── tools/                     # LangChain Tools
│   │   │   │   ├── InfoChecker.java
│   │   │   │   ├── DoctorRecommender.java
│   │   │   │   └── MedicineRecommender.java
│   │   │   │
│   │   │   ├── model/                     # 数据模型
│   │   │   │   ├── dto/
│   │   │   │   │   ├── ChatMessage.java
│   │   │   │   │   ├── PatientInfo.java
│   │   │   │   │   └── RecommendationResult.java
│   │   │   │   └── entity/
│   │   │   │       ├── Doctor.java
│   │   │   │       └── Medicine.java
│   │   │   │
│   │   │   ├── repository/                # 数据访问层
│   │   │   │   ├── DoctorRepository.java
│   │   │   │   ├── MedicineRepository.java
│   │   │   │   └── SessionRepository.java
│   │   │   │
│   │   │   └── constant/                  # 常量
│   │   │       ├── AgentStates.java
│   │   │       └── PromptTemplates.java
│   │   │
│   │   └── resources/
│   │       ├── application.yml
│   │       ├── prompts/                   # 提示词模板
│   │       │   ├── system-prompt.txt
│   │       │   ├── collect-info.txt
│   │       │   └── recommend.txt
│   │       └── data/                      # 初始数据
│   │           ├── doctors.json
│   │           ├── medicines.json
│   │           └── symptoms-mapping.json
│   │
│   └── test/
│       └── java/com/yihu/agent/
│           └── HealthCareApplicationTests.java
│
├── frontend/                              # 前端 (可选)
│   ├── index.html
│   ├── chat.js
│   └── style.css
│
└── README.md
```

## 🔧 核心实现流程

### **消息流转流程**

```
1. 用户发送消息
   ↓
2. WebSocketHandler 接收
   ↓
3. 获取/创建会话状态 (SessionManager)
   ↓
4. 传入 LangGraph 状态机
   ↓
5. 状态机判断当前状态并执行对应 Node
   ↓
6. Node 调用 LangChain4j LLM Service
   ↓
7. LLM 返回响应 / 调用 Tools
   ↓
8. 状态机更新状态
   ↓
9. 通过 WebSocket 返回给用户
   ↓
10. 等待下一条消息 (循环)
```

## 📦 核心依赖 (pom.xml)

```xml
<properties>
    <langchain4j.version>0.35.0</langchain4j.version>
</properties>

<dependencies>
    <!-- Spring Boot Web & WebSocket -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-websocket</artifactId>
    </dependency>
    
    <!-- LangChain4j Core -->
    <dependency>
        <groupId>dev.langchain4j</groupId>
        <artifactId>langchain4j</artifactId>
        <version>${langchain4j.version}</version>
    </dependency>
    
    <!-- LangChain4j OpenAI Integration -->
    <dependency>
        <groupId>dev.langchain4j</groupId>
        <artifactId>langchain4j-open-ai</artifactId>
        <version>${langchain4j.version}</version>
    </dependency>
    
    <!-- LangChain4j Spring Boot Starter -->
    <dependency>
        <groupId>dev.langchain4j</groupId>
        <artifactId>langchain4j-spring-boot-starter</artifactId>
        <version>${langchain4j.version}</version>
    </dependency>
    
    <!-- Redis (可选，用于会话持久化) -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    
    <!-- JSON处理 -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
    </dependency>
</dependencies>
```

## 💡 MVP 功能清单

**第一阶段：信息收集** (Week 1-2)
- ✅ WebSocket 实时对话
- ✅ 多轮对话历史记忆
- ✅ 结构化信息提取（年龄、性别、症状等）
- ✅ 信息完整度判断
- ✅ 智能追问

**第二阶段：推荐引擎** (Week 3)
- ✅ 基于症状的科室匹配
- ✅ 医生推荐（Top 3）
- ✅ 非处方药推荐 + 免责声明
- ✅ 推荐结果展示

**基础设施** (Week 1)
- ✅ 项目框架搭建
- ✅ LangGraph 状态机
- ✅ 医生/药物数据准备

---

## 🚀 下一步

我可以帮您：
1. **立即搭建完整项目骨架** - 生成所有文件和配置
2. **实现核心状态机** - LangGraph4j 流程
3. **WebSocket 通信** - 实时对话功能
4. **准备测试数据** - 医生和药物 JSON

需要我现在开始实现吗？您希望先从哪个部分开始？