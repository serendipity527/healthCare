# åœ¨çº¿ç”¨æˆ·åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²åœ¨ STOMP ç‚¹å¯¹ç‚¹æ¶ˆæ¯ç³»ç»Ÿä¸­æ·»åŠ **å®æ—¶åœ¨çº¿ç”¨æˆ·å±•ç¤º**åŠŸèƒ½ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- âœ… **å®æ—¶æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨**
- âœ… **è‡ªåŠ¨ç›‘å¬ç”¨æˆ·ä¸Šä¸‹çº¿**
- âœ… **æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·æ•°é‡**
- âœ… **ç‚¹å‡»ç”¨æˆ·åå¿«é€Ÿå‘ç§ä¿¡**
- âœ… **å½“å‰ç”¨æˆ·é«˜äº®æ˜¾ç¤º**
- âœ… **ç”¨æˆ·ä¸Šä¸‹çº¿ç³»ç»Ÿé€šçŸ¥**

---

## ğŸ—ï¸ å®ç°åŸç†

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WebSocketEventListener                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›‘å¬è¿æ¥äº‹ä»¶                                 â”‚  â”‚
â”‚  â”‚  â€¢ SessionConnectedEvent  (ç”¨æˆ·ä¸Šçº¿)         â”‚  â”‚
â”‚  â”‚  â€¢ SessionDisconnectEvent (ç”¨æˆ·ä¸‹çº¿)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åœ¨çº¿ç”¨æˆ·ç®¡ç†                                 â”‚  â”‚
â”‚  â”‚  â€¢ Set<String> onlineUsers (çº¿ç¨‹å®‰å…¨)        â”‚  â”‚
â”‚  â”‚  â€¢ æ·»åŠ /åˆ é™¤ç”¨æˆ·                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å¹¿æ’­ç”¨æˆ·çŠ¶æ€                                 â”‚  â”‚
â”‚  â”‚  â€¢ /topic/user-status                        â”‚  â”‚
â”‚  â”‚  â€¢ åŒ…å«ï¼šuserId, status, onlineUsers         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
                 æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯æ”¶åˆ°
```

---

## ğŸ“ æ¶‰åŠçš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

1. **`WebSocketEventListener.java`** - æ–°å¢æ–‡ä»¶ â­
   - ç›‘å¬ WebSocket è¿æ¥å’Œæ–­å¼€äº‹ä»¶
   - ç»´æŠ¤åœ¨çº¿ç”¨æˆ·é›†åˆ
   - å¹¿æ’­ç”¨æˆ·çŠ¶æ€å˜åŒ–

### å‰ç«¯æ–‡ä»¶

2. **`test-stomp-p2p.html`** - å·²ä¿®æ”¹ â­
   - æ·»åŠ åœ¨çº¿ç”¨æˆ· UI
   - è®¢é˜…ç”¨æˆ·çŠ¶æ€æ›´æ–°
   - å®æ—¶æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨

---

## ğŸ”‘ æ ¸å¿ƒä»£ç 

### åç«¯ï¼šWebSocketEventListener

```java
@Component
@Slf4j
public class WebSocketEventListener {
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
    // åœ¨çº¿ç”¨æˆ·é›†åˆï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private final Set<String> onlineUsers = ConcurrentHashMap.newKeySet();
    
    // ç›‘å¬ç”¨æˆ·ä¸Šçº¿
    @EventListener
    public void handleWebSocketConnectListener(SessionConnectedEvent event) {
        Principal user = headerAccessor.getUser();
        if (user != null) {
            String userId = user.getName();
            onlineUsers.add(userId);
            
            // å¹¿æ’­ç”¨æˆ·ä¸Šçº¿é€šçŸ¥
            broadcastUserStatus(userId, "online", onlineUsers);
        }
    }
    
    // ç›‘å¬ç”¨æˆ·ä¸‹çº¿
    @EventListener
    public void handleWebSocketDisconnectListener(SessionDisconnectEvent event) {
        Principal user = headerAccessor.getUser();
        if (user != null) {
            String userId = user.getName();
            onlineUsers.remove(userId);
            
            // å¹¿æ’­ç”¨æˆ·ä¸‹çº¿é€šçŸ¥
            broadcastUserStatus(userId, "offline", onlineUsers);
        }
    }
    
    // å¹¿æ’­ç”¨æˆ·çŠ¶æ€
    private void broadcastUserStatus(String userId, String status, Set<String> currentOnlineUsers) {
        Map<String, Object> statusMessage = Map.of(
            "type", "user_status",
            "userId", userId,
            "status", status,
            "onlineUsers", currentOnlineUsers,
            "onlineCount", currentOnlineUsers.size()
        );
        
        messagingTemplate.convertAndSend("/topic/user-status", statusMessage);
    }
}
```

---

### å‰ç«¯ï¼šè®¢é˜…ç”¨æˆ·çŠ¶æ€

```javascript
// è®¢é˜…ç”¨æˆ·çŠ¶æ€ï¼ˆä¸Šçº¿/ä¸‹çº¿ï¼‰
function subscribeToUserStatus() {
    const subscription = stompClient.subscribe('/topic/user-status', function(message) {
        const data = JSON.parse(message.body);
        
        if (data.type === 'user_status') {
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            onlineUsers = new Set(data.onlineUsers);
            updateOnlineUserList();
            
            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
            if (data.status === 'online' && data.userId !== currentUserId) {
                addSystemMessage(`${data.userId} ä¸Šçº¿äº†`);
            } else if (data.status === 'offline' && data.userId !== currentUserId) {
                addSystemMessage(`${data.userId} ä¸‹çº¿äº†`);
            }
        }
    });
}
```

---

### å‰ç«¯ï¼šæ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨

```javascript
function updateOnlineUserList() {
    const listDiv = document.getElementById('onlineUserList');
    const countSpan = document.getElementById('onlineUserCount');
    
    countSpan.textContent = onlineUsers.size;
    
    if (onlineUsers.size === 0) {
        listDiv.innerHTML = '<div style="color: #999;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
    } else {
        listDiv.innerHTML = '';
        
        // å°†åœ¨çº¿ç”¨æˆ·åˆ—è¡¨è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆå½“å‰ç”¨æˆ·æ’åœ¨ç¬¬ä¸€ä½ï¼‰
        const sortedUsers = Array.from(onlineUsers).sort((a, b) => {
            if (a === currentUserId) return -1;
            if (b === currentUserId) return 1;
            return a.localeCompare(b);
        });
        
        sortedUsers.forEach(userId => {
            const badge = document.createElement('span');
            badge.className = userId === currentUserId ? 'user-badge me' : 'user-badge';
            badge.textContent = userId === currentUserId ? `${userId} (æˆ‘)` : userId;
            
            // ç‚¹å‡»ç”¨æˆ·åè‡ªåŠ¨å¡«å……åˆ°ç§ä¿¡ç›®æ ‡
            if (userId !== currentUserId) {
                badge.style.cursor = 'pointer';
                badge.onclick = function() {
                    document.getElementById('targetUserId').value = userId;
                    document.getElementById('privateMessageInput').focus();
                };
                badge.title = 'ç‚¹å‡»å‘é€ç§ä¿¡';
            }
            
            listDiv.appendChild(badge);
        });
    }
}
```

---

## ğŸ“¨ æ¶ˆæ¯æ ¼å¼

### ç”¨æˆ·çŠ¶æ€æ¶ˆæ¯

**å¹¿æ’­åˆ°**ï¼š`/topic/user-status`

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
    "type": "user_status",
    "userId": "Alice",
    "status": "online",  // æˆ– "offline"
    "onlineUsers": ["Alice", "Bob", "Charlie"],
    "onlineCount": 3
}
```

---

## ğŸ¨ UI å±•ç¤º

### åœ¨çº¿ç”¨æˆ·é¢æ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ åœ¨çº¿ç”¨æˆ· (3)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Alice (æˆ‘)]  [Bob]  [Charlie]     â”‚
â”‚                                     â”‚
â”‚  â€¢ è“è‰²ï¼šå½“å‰ç”¨æˆ·                   â”‚
â”‚  â€¢ ç»¿è‰²ï¼šå…¶ä»–ç”¨æˆ·                   â”‚
â”‚  â€¢ ç‚¹å‡»ï¼šå¿«é€Ÿå‘ç§ä¿¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‰¹è‰²åŠŸèƒ½

1. **å½“å‰ç”¨æˆ·é«˜äº®**
   - å½“å‰ç”¨æˆ·æ˜¾ç¤ºä¸ºè“è‰² badge
   - æ ‡æ³¨"(æˆ‘)"

2. **ç‚¹å‡»å¿«é€Ÿç§ä¿¡**
   - ç‚¹å‡»å…¶ä»–ç”¨æˆ·å
   - è‡ªåŠ¨å¡«å……åˆ°ç§ä¿¡ç›®æ ‡
   - ç„¦ç‚¹ç§»åŠ¨åˆ°æ¶ˆæ¯è¾“å…¥æ¡†

3. **åŠ¨ç”»æ•ˆæœ**
   - ç”¨æˆ·ä¸Šçº¿æ·¡å…¥åŠ¨ç”»
   - å¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯•åœºæ™¯ 1ï¼šåŒç”¨æˆ·ä¸Šä¸‹çº¿

**æ­¥éª¤**ï¼š

1. **æ‰“å¼€ç¬¬ä¸€ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**
   - ç”¨æˆ·IDï¼š`Alice`
   - ç‚¹å‡»"è¿æ¥"
   - éªŒè¯åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºï¼š`Alice (æˆ‘)`

2. **æ‰“å¼€ç¬¬äºŒä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**
   - ç”¨æˆ·IDï¼š`Bob`
   - ç‚¹å‡»"è¿æ¥"
   - **Alice çš„æ ‡ç­¾é¡µ**åº”è¯¥çœ‹åˆ°ï¼š
     - ç³»ç»Ÿæ¶ˆæ¯ï¼š"Bob ä¸Šçº¿äº†"
     - åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°ä¸ºï¼š`Alice (æˆ‘)`, `Bob`
   - **Bob çš„æ ‡ç­¾é¡µ**åº”è¯¥çœ‹åˆ°ï¼š
     - åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºï¼š`Bob (æˆ‘)`, `Alice`

3. **Bob æ–­å¼€è¿æ¥**
   - åœ¨ Bob çš„æ ‡ç­¾é¡µç‚¹å‡»"æ–­å¼€"
   - **Alice çš„æ ‡ç­¾é¡µ**åº”è¯¥çœ‹åˆ°ï¼š
     - ç³»ç»Ÿæ¶ˆæ¯ï¼š"Bob ä¸‹çº¿äº†"
     - åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°ä¸ºï¼š`Alice (æˆ‘)`

---

### æµ‹è¯•åœºæ™¯ 2ï¼šå¿«é€Ÿå‘ç§ä¿¡

**æ­¥éª¤**ï¼š

1. **è¿æ¥ä¸¤ä¸ªç”¨æˆ·**ï¼šAlice å’Œ Bob

2. **åœ¨ Alice çš„æ ‡ç­¾é¡µ**
   - ç‚¹å‡»åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä¸­çš„ `Bob`
   - éªŒè¯ï¼š
     - "ç›®æ ‡ç”¨æˆ·ID"è¾“å…¥æ¡†è‡ªåŠ¨å¡«å……ä¸º `Bob`
     - ç„¦ç‚¹ç§»åŠ¨åˆ°"ç§ä¿¡å†…å®¹"è¾“å…¥æ¡†

3. **è¾“å…¥æ¶ˆæ¯å¹¶å‘é€**
   - è¾“å…¥ï¼š`ä½ å¥½ï¼ŒBobï¼`
   - ç‚¹å‡»"å‘é€"
   - éªŒè¯ Bob æ”¶åˆ°æ¶ˆæ¯

---

### æµ‹è¯•åœºæ™¯ 3ï¼šå¤šç”¨æˆ·åŒæ—¶åœ¨çº¿

**æ­¥éª¤**ï¼š

1. **æ‰“å¼€ 4 ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**
   - user001, user002, user003, user004

2. **ä¾æ¬¡è¿æ¥**
   - è§‚å¯Ÿæ¯ä¸ªæ ‡ç­¾é¡µçš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
   - éªŒè¯åœ¨çº¿äººæ•°ç»Ÿè®¡æ­£ç¡®

3. **éšæœºæ–­å¼€æŸä¸ªç”¨æˆ·**
   - è§‚å¯Ÿå…¶ä»–æ ‡ç­¾é¡µçš„ç³»ç»Ÿé€šçŸ¥
   - éªŒè¯åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å®æ—¶æ›´æ–°

---

## ğŸ”§ é…ç½®è¯´æ˜

### è®¢é˜…è·¯å¾„

å‰ç«¯éœ€è¦è®¢é˜…ä»¥ä¸‹è·¯å¾„ï¼š

```javascript
// ç”¨æˆ·çŠ¶æ€æ›´æ–°
stompClient.subscribe('/topic/user-status', callback);
```

### å¹¿æ’­è·¯å¾„

åç«¯é€šè¿‡ä»¥ä¸‹è·¯å¾„å¹¿æ’­ç”¨æˆ·çŠ¶æ€ï¼š

```java
messagingTemplate.convertAndSend("/topic/user-status", statusMessage);
```

---

## ğŸ’¡ æ‰©å±•å»ºè®®

### 1. æ·»åŠ ç”¨æˆ·å¤´åƒ

```javascript
badge.innerHTML = `
    <img src="/api/users/${userId}/avatar" class="user-avatar">
    ${userId === currentUserId ? userId + ' (æˆ‘)' : userId}
`;
```

### 2. æ˜¾ç¤ºç”¨æˆ·åœ¨çº¿æ—¶é•¿

```java
private final Map<String, Long> userLoginTime = new ConcurrentHashMap<>();

@EventListener
public void handleWebSocketConnectListener(SessionConnectedEvent event) {
    String userId = ...;
    userLoginTime.put(userId, System.currentTimeMillis());
    // ...
}
```

### 3. ç”¨æˆ·çŠ¶æ€ï¼ˆåœ¨çº¿/å¿™ç¢Œ/ç¦»å¼€ï¼‰

```java
private enum UserStatus {
    ONLINE, BUSY, AWAY
}

private final Map<String, UserStatus> userStatuses = new ConcurrentHashMap<>();
```

### 4. ç”¨æˆ·æœç´¢/è¿‡æ»¤

```javascript
function filterUsers(keyword) {
    const filtered = Array.from(onlineUsers).filter(u => 
        u.toLowerCase().includes(keyword.toLowerCase())
    );
    updateOnlineUserList(filtered);
}
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. çº¿ç¨‹å®‰å…¨

ä½¿ç”¨ `ConcurrentHashMap.newKeySet()` åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„ Setï¼š

```java
private final Set<String> onlineUsers = ConcurrentHashMap.newKeySet();
```

### 2. äº‹ä»¶ç›‘å¬æ—¶æœº

- `SessionConnectedEvent`ï¼šåœ¨ STOMP CONNECTED å¸§ä¹‹åè§¦å‘
- `SessionDisconnectEvent`ï¼šåœ¨è¿æ¥å…³é—­åè§¦å‘

### 3. ç”¨æˆ·èº«ä»½è·å–

å¿…é¡»åœ¨è¿æ¥æ—¶è®¾ç½® Principalï¼š

```java
// åœ¨ ChannelInterceptor ä¸­è®¾ç½®
accessor.setUser(() -> userId);
```

### 4. å†…å­˜ç®¡ç†

å®šæœŸæ¸…ç†æ–­å¼€è¿æ¥ä½†æœªè§¦å‘äº‹ä»¶çš„ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰ï¼š

```java
@Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿ
public void cleanupStaleUsers() {
    // æ¸…ç†é€»è¾‘
}
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡æ›´æ–°**
   - å¦‚æœçŸ­æ—¶é—´å†…å¤šä¸ªç”¨æˆ·ä¸Šä¸‹çº¿
   - å¯ä»¥è€ƒè™‘æ‰¹é‡å‘é€çŠ¶æ€æ›´æ–°

2. **å¢é‡æ›´æ–°**
   - ä»…å‘é€å˜åŒ–çš„ç”¨æˆ·
   - è€Œä¸æ˜¯æ¯æ¬¡éƒ½å‘é€å®Œæ•´åˆ—è¡¨

3. **å‹ç¼©**
   - å¯¹äºå¤§é‡åœ¨çº¿ç”¨æˆ·
   - è€ƒè™‘å‹ç¼©ç”¨æˆ·åˆ—è¡¨æ•°æ®

---

## âœ… æ€»ç»“

âœ… **åŠŸèƒ½å®Œæ•´**ï¼šå®æ—¶æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨  
âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šç‚¹å‡»ç”¨æˆ·åå¿«é€Ÿå‘ç§ä¿¡  
âœ… **å®æ—¶æ€§å¼º**ï¼šè‡ªåŠ¨ç›‘å¬ä¸Šä¸‹çº¿äº‹ä»¶  
âœ… **ä»£ç ä¼˜é›…**ï¼šä½¿ç”¨ Spring äº‹ä»¶æœºåˆ¶  
âœ… **æ˜“äºæ‰©å±•**ï¼šå¯æ·»åŠ æ›´å¤šç”¨æˆ·çŠ¶æ€åŠŸèƒ½  

---

**ç›¸å…³æ–‡ä»¶**ï¼š
- åç«¯ï¼š`src/main/java/com/yihu/agent/websocket/WebSocketEventListener.java`
- å‰ç«¯ï¼š`Front/test-stomp-p2p.html`

**æµ‹è¯•é¡µé¢**ï¼šç›´æ¥æ‰“å¼€ `Front/test-stomp-p2p.html` å³å¯ä½“éªŒï¼

---

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

