# 在线用户显示问题修复

## 🐛 问题描述

**现象**：有的用户能看到在线用户列表，有的用户显示"暂无在线用户"

**复现步骤**：
1. 用户 A 先连接 → 看到"暂无在线用户"
2. 用户 B 后连接 → 能看到完整的在线用户列表（包括 A 和 B）

---

## 🔍 问题原因

### 原始流程分析

```
用户 A 连接
  ↓
触发 SessionConnectedEvent
  ↓
广播 user_status 到 /topic/user-status
  ↓
❌ 此时用户 A 的订阅还未完成或刚完成
  ↓
用户 A 错过了广播消息
  ↓
结果：用户 A 的在线列表为空

---

用户 B 连接
  ↓
触发 SessionConnectedEvent
  ↓
广播 user_status 到 /topic/user-status
  ↓
✅ 用户 A 已经订阅，收到广播
✅ 用户 B 可能也收到（取决于时序）
  ↓
结果：用户 A 和 B 都能看到完整列表
```

### 核心问题

- **广播时机问题**：用户连接时立即广播，但用户自己的订阅可能还未生效
- **第一个用户问题**：第一个连接的用户没有其他人可以广播给他
- **时序依赖**：依赖广播消息来初始化在线列表，不可靠

---

## ✅ 解决方案

### 修复思路

在用户连接时，**主动发送**完整的在线用户列表给该用户，而不是依赖广播。

### 修复后的流程

```
用户连接
  ↓
触发 SessionConnectedEvent
  ↓
1️⃣ 先发送在线列表给新用户（点对点）
   • 目标：/user/{userId}/queue/user-list
   • 包含：完整的 onlineUsers 列表
   • 确保：新用户一定能收到
  ↓
2️⃣ 再广播用户上线通知（广播）
   • 目标：/topic/user-status
   • 通知：其他用户有人上线了
```

---

## 🔧 代码修改

### 后端修改

**文件**：`src/main/java/com/yihu/agent/websocket/WebSocketEventListener.java`

#### 1. 添加发送用户列表方法

```java
/**
 * 发送在线用户列表给指定用户（用户刚连接时调用）
 */
private void sendUserListToUser(String userId, Set<String> currentOnlineUsers) {
    Map<String, Object> userListMessage = Map.of(
        "type", "user_list",
        "onlineUsers", currentOnlineUsers,
        "onlineCount", currentOnlineUsers.size()
    );
    
    // 发送给指定用户（点对点）
    messagingTemplate.convertAndSendToUser(
        userId,
        "/queue/user-list",
        userListMessage
    );
    
    log.debug("已发送在线用户列表给用户: {}, 在线人数: {}", userId, currentOnlineUsers.size());
}
```

#### 2. 修改连接事件处理

```java
@EventListener
public void handleWebSocketConnectListener(SessionConnectedEvent event) {
    StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());
    
    Principal user = headerAccessor.getUser();
    if (user != null) {
        String userId = user.getName();
        onlineUsers.add(userId);
        
        log.info("用户上线: {}, 当前在线人数: {}", userId, onlineUsers.size());
        
        // 1️⃣ 先给新连接的用户发送当前的在线用户列表（关键！）
        sendUserListToUser(userId, onlineUsers);
        
        // 2️⃣ 再广播用户上线通知给其他人
        broadcastUserStatus(userId, "online", onlineUsers);
    }
}
```

---

### 前端修改

**文件**：`Front/test-stomp-p2p.html`

#### 1. 添加订阅用户列表

```javascript
// 订阅个人的用户列表（连接时接收完整的在线用户列表）
function subscribeToUserList() {
    const subscription = stompClient.subscribe('/user/queue/user-list', function(message) {
        console.log('📩 收到在线用户列表:', message.body);
        
        const data = JSON.parse(message.body);
        
        if (data.type === 'user_list') {
            // 初始化在线用户列表
            onlineUsers = new Set(data.onlineUsers);
            updateOnlineUserList();
            
            console.log('✅ 在线用户列表已初始化，当前在线:', data.onlineCount, '人');
        }
    });

    addSubscription('/user/queue/user-list', subscription.id);
}
```

#### 2. 在连接成功后调用

```javascript
stompClient.connect(
    { userId: userId },
    function(frame) {
        console.log('✅ STOMP 连接成功:', frame);
        
        // 订阅广播消息
        subscribeToTopic();
        
        // 订阅个人私信
        subscribeToPrivateMessages();
        
        // 订阅消息回执
        subscribeToReceipts();
        
        // 订阅用户状态
        subscribeToUserStatus();
        
        // 订阅个人的用户列表（新增！）
        subscribeToUserList();
    }
);
```

---

## 📨 新增的消息格式

### 在线用户列表消息

**发送到**：`/user/{userId}/queue/user-list`（点对点）

**消息格式**：
```json
{
    "type": "user_list",
    "onlineUsers": ["Alice", "Bob", "Charlie"],
    "onlineCount": 3
}
```

**时机**：用户连接时立即发送

---

## 🎯 修复效果对比

### 修复前

| 用户 | 连接顺序 | 能否看到在线用户 |
|------|---------|-----------------|
| Alice | 第1个 | ❌ 看不到 |
| Bob | 第2个 | ✅ 能看到 |
| Charlie | 第3个 | ✅ 能看到 |

### 修复后

| 用户 | 连接顺序 | 能否看到在线用户 |
|------|---------|-----------------|
| Alice | 第1个 | ✅ 能看到（自己） |
| Bob | 第2个 | ✅ 能看到（Alice, Bob） |
| Charlie | 第3个 | ✅ 能看到（Alice, Bob, Charlie） |

---

## 🧪 验证测试

### 测试步骤

1. **重启服务器**
   ```bash
   mvn spring-boot:run
   ```

2. **打开第一个浏览器标签页**
   - 用户ID：`Alice`
   - 点击"连接"
   - ✅ **验证**：立即看到"在线用户 (1)"，显示 `Alice (我)`

3. **打开第二个浏览器标签页**
   - 用户ID：`Bob`
   - 点击"连接"
   - ✅ **验证 Alice**：看到"在线用户 (2)"，显示 `Alice (我)`, `Bob`
   - ✅ **验证 Bob**：看到"在线用户 (2)"，显示 `Bob (我)`, `Alice`

4. **打开第三个浏览器标签页**
   - 用户ID：`Charlie`
   - 点击"连接"
   - ✅ **验证所有用户**：都看到"在线用户 (3)"，包含三个用户

---

## 💡 设计优势

### 1. 双重保障机制

```
点对点发送（初始化）
  +
广播更新（实时同步）
  =
可靠的在线用户列表
```

### 2. 时序无关

- **点对点发送**：确保用户连接后立即获得完整列表
- **不依赖广播时序**：即使订阅未完成也能收到

### 3. 职责分离

- **用户列表初始化**：`/user/queue/user-list`（点对点）
- **用户状态更新**：`/topic/user-status`（广播）

---

## 📊 消息流程图

```
新用户连接
    │
    ├─> [点对点] 发送完整用户列表
    │       ↓
    │   /user/{userId}/queue/user-list
    │       ↓
    │   新用户立即看到所有在线用户 ✅
    │
    └─> [广播] 通知其他用户有人上线
            ↓
        /topic/user-status
            ↓
        其他用户更新列表 ✅
```

---

## 🔍 日志验证

修复后，服务器日志应该显示：

```
用户上线: Alice, 当前在线人数: 1
已发送在线用户列表给用户: Alice, 在线人数: 1

用户上线: Bob, 当前在线人数: 2
已发送在线用户列表给用户: Bob, 在线人数: 2

用户上线: Charlie, 当前在线人数: 3
已发送在线用户列表给用户: Charlie, 在线人数: 3
```

浏览器控制台应该显示：

```
Alice 的控制台：
📩 收到在线用户列表: {"type":"user_list","onlineUsers":["Alice"],"onlineCount":1}
✅ 在线用户列表已初始化，当前在线: 1 人

Bob 的控制台：
📩 收到在线用户列表: {"type":"user_list","onlineUsers":["Alice","Bob"],"onlineCount":2}
✅ 在线用户列表已初始化，当前在线: 2 人
```

---

## ✅ 总结

### 问题根源
- 依赖广播初始化在线列表
- 第一个用户无法收到广播

### 解决方案
- 连接时主动发送完整列表（点对点）
- 状态变化时广播更新（广播）

### 修复结果
- ✅ 所有用户都能看到完整的在线用户列表
- ✅ 第一个连接的用户也能正常显示
- ✅ 实时更新无延迟

---

**现在刷新页面测试，所有用户都能正常看到在线用户列表了！** 🎉

